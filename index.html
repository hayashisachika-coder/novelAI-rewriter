<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>AIÂü∑Á≠Ü„Ç®„Éá„Ç£„Çø</title>
    <style>
        /* --- ÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´ --- */
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS PMincho", "serif";
            background-color: #f0f2f5;
            overscroll-behavior: none; 
        }
        #app-container {
            display: flex; flex-direction: column;
            height: 100dvh; 
            width: 100%; max-width: 600px; margin: 0 auto;
            background-color: #ffffff; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* --- „Éò„ÉÉ„ÉÄ„Éº --- */
        header {
            background-color: #f9f9f9; color: #333; padding: 12px 15px;
            font-size: 16px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ddd;
            position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .header-btn {
            background: none; border: 1px solid #ccc; border-radius: 5px;
            cursor: pointer; padding: 5px 10px; font-size: 18px; background-color: #fff;
        }
        .header-btn:active { background-color: #e0e0e0; }
        #current-title {
            font-size: 14px; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer; border-bottom: 1px dotted #999;
        }
        #char-count {
            font-size: 12px; font-weight: normal; color: #666;
            background-color: #eee; padding: 4px 8px; border-radius: 10px;
        }

        /* --- ÂéüÁ®ø„Ç®„É™„Ç¢ --- */
        #manuscript-area {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            background-color: #ffffff; font-size: 16px; line-height: 1.8;
            padding-bottom: 50px; 
        }
        
        /* „Éñ„É≠„ÉÉ„ÇØÊú¨‰Ωì */
        .manuscript-block {
            padding: 10px 0; 
            display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;
        }
        .block-text { flex-grow: 1; word-wrap: break-word; white-space: pre-wrap; }
        
        /* „Éú„Çø„É≥È°û„Çí„Åæ„Å®„ÇÅ„Çã„É©„ÉÉ„Éë„Éº */
        .block-actions {
            display: flex; gap: 5px; flex-shrink: 0;
            opacity: 0.3; transition: opacity 0.2s;
        }
        /* „Éõ„Éê„ÉºÊôÇ„Å´„Éú„Çø„É≥„Çí„ÅØ„Å£„Åç„ÇäË°®Á§∫ */
        .manuscript-block:hover .block-actions { opacity: 1; }

        /* ÂÄãÂà•„ÅÆÊìç‰Ωú„Éú„Çø„É≥ */
        .action-icon-btn {
            padding: 5px; cursor: pointer; border-radius: 4px;
            min-width: 24px; text-align: center; font-family: sans-serif;
            background-color: transparent; border: none; font-size: 16px;
        }
        .action-icon-btn:hover { background-color: #f0f0f0; }
        
        /* ÂâäÈô§„Éú„Çø„É≥„Å†„Åë„Éõ„Éê„ÉºÊôÇ„Å´Ëµ§„Åè */
        .delete-button:hover { background-color: #ffebee; color: #d32f2f; }
        
        .manuscript-block.info { color: #888; cursor: default; border-bottom: 1px solid #eee; }
        .manuscript-block.is-editing { background-color: #e3f2fd; border-radius: 5px; padding-left: 5px; padding-right: 5px;}

        /* ÊåøÂÖ•Áî®„Ç®„É™„Ç¢Ôºà„Éñ„É≠„ÉÉ„ÇØÈñì„ÅÆÈöôÈñìÔºâ */
        .insert-gap {
            height: 24px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; margin: 5px 0;
        }
        .insert-gap::before {
            content: ""; position: absolute; width: 100%; height: 1px; 
            background-color: #eee; transition: background-color 0.2s;
        }
        .insert-btn {
            z-index: 1; background-color: #fff; color: #ccc; border: 1px solid #eee;
            width: 20px; height: 20px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s;
        }
        .insert-gap:hover::before, .insert-gap.active::before { background-color: #4A90E2; }
        .insert-gap:hover .insert-btn, .insert-gap.active .insert-btn {
            background-color: #4A90E2; color: white; border-color: #4A90E2; transform: scale(1.2);
        }

        /* --- Âü∑Á≠Ü„Ç®„É™„Ç¢ --- */
        #writing-area {
            display: flex; align-items: flex-end; padding: 10px;
            border-top: 1px solid #ddd; background-color: #f9f9f9;
            position: sticky; bottom: 0; z-index: 100;
        }
        #text-input {
            flex-grow: 1; font-size: 16px; padding: 10px 12px; border: 1px solid #ccc;
            border-radius: 20px; margin-right: 8px; resize: none; max-height: 120px; overflow-y: auto;
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS PMincho", "serif";
        }
        #text-input.insert-mode { border: 2px solid #4A90E2; background-color: #f0f8ff; }
        
        .action-button {
            display: flex; align-items: center; justify-content: center; width: 44px; height: 44px;
            border-radius: 50%; border: none; cursor: pointer; font-size: 20px; flex-shrink: 0;
        }
        #ai-btn { background-color: #8E44AD; color: white; margin-right: 5px; }
        #confirm-btn { background-color: #4A90E2; color: white; }

        /* --- „É¢„Éº„ÉÄ„É´ --- */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content { position: absolute; bottom: 0; width: 100%; height: 90vh; max-width: 600px; left: 50%; transform: translateX(-50%); background-color: #ffffff; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .close-modal-btn { font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; padding: 5px; }

        /* AI„É¢„Éº„ÉÄ„É´ */
        #original-text-area { padding: 10px 15px; background-color: #f7f7f7; border-bottom: 1px solid #eee; max-height: 100px; overflow-y: auto; }
        .original-label { font-size: 12px; font-weight: bold; color: #888; display: block; margin-bottom: 5px; }
        #original-text-content { font-size: 14px; color: #555; white-space: pre-wrap; }
        .suggestion-tabs { display: flex; justify-content: space-around; border-bottom: 1px solid #eee; }
        .tab { padding: 15px; cursor: pointer; color: #888; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { color: #4A90E2; border-bottom-color: #4A90E2; }
        #suggestion-text { flex-grow: 1; padding: 20px; font-size: 16px; line-height: 1.6; overflow-y: auto; white-space: pre-wrap; background-color: #f9f9f9; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; background-color: #f9f9f9; }
        #more-request-input { width: calc(100% - 24px); padding: 10px 12px; border: 1px solid #ccc; border-radius: 20px; margin-bottom: 10px; }
        #decision-btn { width: 100%; padding: 15px; background-color: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }

        /* ‰ΩúÂìÅ‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´ */
        #story-list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .story-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .story-item:hover { background-color: #f9f9f9; }
        .story-item.active { background-color: #f0f8ff; border-left: 5px solid #4A90E2; }
        .story-info { flex-grow: 1; }
        .story-title { font-weight: bold; font-size: 16px; display: block; margin-bottom: 4px; }
        .story-date { font-size: 12px; color: #888; }
        .story-delete-btn { padding: 8px 12px; background-color: #ffebee; color: #d32f2f; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; margin-left: 10px; }
        #create-new-story-btn { width: 100%; padding: 15px; background-color: #4A90E2; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="header-left">
                <button id="menu-btn" class="header-btn" title="‰ΩúÂìÅ‰∏ÄË¶ß">‚ò∞</button>
                <span id="current-title" title="„Çø„ÉÉ„Éó„Åó„Å¶„Çø„Ç§„Éà„É´Â§âÊõ¥">ÁÑ°È°å„ÅÆÁâ©Ë™û</span>
            </div>
            
            <div class="header-right">
                <button id="copy-all-btn" class="header-btn" title="ÂÖ®Êñá„Ç≥„Éî„Éº">üìã</button>
                <button id="clear-all-btn" class="header-btn" title="ÂÖ®Ê∂àÂéª">üóëÔ∏è</button>
                <span id="char-count">0ÊñáÂ≠ó</span>
            </div>
        </header>

        <div id="manuscript-area"></div>

        <div id="writing-area">
            <textarea id="text-input" rows="1" placeholder="ÊñáÁ´†„ÇíÂÖ•Âäõ..."></textarea>
            <button id="ai-btn" class="action-button">‚ú®</button>
            <button id="confirm-btn" class="action-button">‚¨ÜÔ∏è</button>
        </div>
    </div>

    <div id="ai-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>AI„É™„É©„Ç§„ÉàÊèêÊ°à</span>
                <span id="close-ai-modal" class="close-modal-btn">√ó</span>
            </div>
            <div id="original-text-area">
                <span class="original-label">ÂÖÉ„ÅÆÊñáÁ´†:</span>
                <div id="original-text-content"></div>
            </div>
            <div class="suggestion-tabs">
                <span class="tab active" data-index="0">ÊèêÊ°à 1</span>
                <span class="tab" data-index="1">ÊèêÊ°à 2</span>
                <span class="tab" data-index="2">ÊèêÊ°à 3</span>
            </div>
            <div id="suggestion-text"></div>
            <div class="modal-footer">
                <input type="text" id="more-request-input" placeholder="ËøΩÂä†„ÅÆÊåáÁ§∫Ôºà‰æãÔºö„ÇÇ„Å£„Å®ÊÉÖÊôØÊèèÂÜô„ÇíÔºâ">
                <button id="decision-btn">„Åì„ÅÆÂÜÖÂÆπ„ÅßÊ±∫ÂÆö</button>
            </div>
        </div>
    </div>

    <div id="story-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>‰ΩúÂìÅ‰∏ÄË¶ß</span>
                <span id="close-story-modal" class="close-modal-btn">√ó</span>
            </div>
            <div id="story-list-container"></div>
            <div class="modal-footer">
                <button id="create-new-story-btn">Ôºã Êñ∞„Åó„ÅÑ‰ΩúÂìÅ„Çí‰ΩúÊàê</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOMË¶ÅÁ¥† ---
        const textInput = document.getElementById('text-input');
        const confirmBtn = document.getElementById('confirm-btn');
        const aiBtn = document.getElementById('ai-btn');
        const manuscriptArea = document.getElementById('manuscript-area');
        const charCountDisplay = document.getElementById('char-count');
        const copyAllBtn = document.getElementById('copy-all-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const menuBtn = document.getElementById('menu-btn');
        const currentTitleSpan = document.getElementById('current-title');
        
        const aiModal = document.getElementById('ai-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal');
        const suggestionText = document.getElementById('suggestion-text');
        const decisionBtn = document.getElementById('decision-btn');
        const moreRequestInput = document.getElementById('more-request-input');
        const tabs = document.querySelectorAll('.tab');
        const originalTextContent = document.getElementById('original-text-content');

        const storyListModal = document.getElementById('story-list-modal');
        const closeStoryModalBtn = document.getElementById('close-story-modal');
        const storyListContainer = document.getElementById('story-list-container');
        const createNewStoryBtn = document.getElementById('create-new-story-btn');

        // --- „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ---
        let currentSuggestions = []; 
        let currentSuggestionIndex = 0; 
        let editingBlockId = null; 
        let insertTargetId = null; 

        // ‚òÖ‚òÖ‚òÖ GAS URL („Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆURL) ‚òÖ‚òÖ‚òÖ
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxMCdYvJVs36E5I32cUSuqQox-1IP1L3MBQalQF_YXUF4hd1j0Bwlawvzxb_Qb38pc/exec"; 

        const STORY_INDEX_KEY = 'ai_novel_story_index'; 
        let currentStoryId = null;

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeEditor();

            textInput.addEventListener('input', autoResizeTextarea);
            confirmBtn.addEventListener('click', handleConfirm);
            
            aiBtn.addEventListener('click', openAiModal);
            closeAiModalBtn.addEventListener('click', () => aiModal.style.display = 'none');
            tabs.forEach(tab => tab.addEventListener('click', () => switchSuggestion(parseInt(tab.dataset.index))));
            decisionBtn.addEventListener('click', handleAiDecision);
            moreRequestInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim() !== '') {
                    handleAiMoreRequest(e.target.value); e.target.value = '';
                }
            });

            manuscriptArea.addEventListener('click', handleAreaClick); 
            copyAllBtn.addEventListener('click', handleCopyAll);
            clearAllBtn.addEventListener('click', handleClearAll);
            
            menuBtn.addEventListener('click', openStoryListModal);
            closeStoryModalBtn.addEventListener('click', () => storyListModal.style.display = 'none');
            createNewStoryBtn.addEventListener('click', handleCreateNewStory);
            currentTitleSpan.addEventListener('click', handleChangeTitle);
        });

        // --- Á¢∫ÂÆö„Éú„Çø„É≥Âá¶ÁêÜ ---
        function handleConfirm() {
            const text = textInput.value;
            if (text.trim() === '') { resetInputState(); return; }

            if (editingBlockId) {
                const editingBlock = document.querySelector(`[data-id="${editingBlockId}"]`);
                if (editingBlock) {
                    const textSpan = editingBlock.querySelector('.block-text');
                    if (textSpan) textSpan.textContent = text;
                    editingBlock.classList.remove('is-editing');
                }
                editingBlockId = null;
            } 
            else if (insertTargetId) {
                const targetBlock = document.querySelector(`[data-id="${insertTargetId}"]`);
                if (targetBlock) {
                    const targetGap = targetBlock.nextElementSibling; 
                    const nextBlock = targetGap ? targetGap.nextElementSibling : null;
                    addManuscriptBlockDOM(text, nextBlock); 
                } else {
                    addManuscriptBlockDOM(text); 
                }
                resetInputState();
            }
            else {
                addManuscriptBlockDOM(text);
                manuscriptArea.scrollTop = manuscriptArea.scrollHeight;
            }
            
            textInput.value = ''; autoResizeTextarea();
            saveManuscript();
        }

        function resetInputState() {
            if (editingBlockId) {
                const b = document.querySelector(`[data-id="${editingBlockId}"]`);
                if (b) b.classList.remove('is-editing');
                editingBlockId = null;
            }
            if (insertTargetId) {
                const gaps = document.querySelectorAll('.insert-gap');
                gaps.forEach(g => g.classList.remove('active'));
                insertTargetId = null;
                textInput.classList.remove('insert-mode');
                textInput.placeholder = "ÊñáÁ´†„ÇíÂÖ•Âäõ...";
            }
            textInput.value = ''; autoResizeTextarea();
        }

        // --- DOMÁîüÊàê ---
        function addManuscriptBlockDOM(text, insertBeforeElement = null) {
            const block = document.createElement('div');
            block.className = 'manuscript-block';
            block.dataset.id = `block-${Date.now()}-${Math.random()}`;

            const textSpan = document.createElement('span');
            textSpan.className = 'block-text';
            textSpan.textContent = text;

            // ‚òÖÂ§âÊõ¥: „Éú„Çø„É≥„Çí„Åæ„Å®„ÇÅ„Çãdiv„Çí‰ΩúÊàê
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'block-actions';

            // Á∑®ÈõÜ„Éú„Çø„É≥
            const editBtn = document.createElement('button');
            editBtn.className = 'action-icon-btn edit-button';
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.title = "Á∑®ÈõÜ";

            // ‚òÖËøΩÂä†: ÂâäÈô§„Éú„Çø„É≥
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-icon-btn delete-button';
            deleteBtn.textContent = 'üóëÔ∏è';
            deleteBtn.title = "ÂâäÈô§";

            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);

            block.appendChild(textSpan);
            block.appendChild(actionsDiv);

            // ÈöôÈñìÔºàÊåøÂÖ•„Éú„Çø„É≥Ôºâ‰ΩúÊàê
            const gap = document.createElement('div');
            gap.className = 'insert-gap';
            gap.dataset.prevId = block.dataset.id;
            const gapBtn = document.createElement('div');
            gapBtn.className = 'insert-btn';
            gapBtn.textContent = '+';
            gap.appendChild(gapBtn);

            if (insertBeforeElement) {
                manuscriptArea.insertBefore(block, insertBeforeElement);
                manuscriptArea.insertBefore(gap, insertBeforeElement);
            } else {
                manuscriptArea.appendChild(block);
                manuscriptArea.appendChild(gap);
            }
        }
        
        // --- „ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜÔºàÁ∑®ÈõÜ„ÉªÂâäÈô§„ÉªÊåøÂÖ•Ôºâ ---
        function handleAreaClick(event) {
            // A. Á∑®ÈõÜ„Éú„Çø„É≥
            const editBtn = event.target.closest('.edit-button');
            if (editBtn) {
                const block = editBtn.closest('.manuscript-block');
                if (!block || block.classList.contains('info')) return;
                resetInputState();
                editingBlockId = block.dataset.id;
                block.classList.add('is-editing');
                textInput.value = block.querySelector('.block-text').textContent;
                autoResizeTextarea(); textInput.focus();
                return;
            }

            // B. ÂâäÈô§„Éú„Çø„É≥ (‚òÖËøΩÂä†)
            const deleteBtn = event.target.closest('.delete-button');
            if (deleteBtn) {
                const block = deleteBtn.closest('.manuscript-block');
                if (!block || block.classList.contains('info')) return;
                
                if (confirm("„Åì„ÅÆÊÆµËêΩ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                    // ‰∏ã„Å´„ÅÇ„Çãgap„ÇÇ‰∏ÄÁ∑í„Å´Ê∂à„ÅôÂøÖË¶Å„Åå„ÅÇ„Çã
                    const nextGap = block.nextElementSibling;
                    if (nextGap && nextGap.classList.contains('insert-gap')) {
                        nextGap.remove();
                    }
                    block.remove();
                    
                    // Á∑®ÈõÜ‰∏≠„Å†„Å£„Åü„ÇÇ„ÅÆ„ÇíÊ∂à„Åó„ÅüÂ†¥Âêà„ÅÆ„É™„Çª„ÉÉ„Éà
                    if (editingBlockId === block.dataset.id) {
                        resetInputState();
                    }
                    saveManuscript();
                }
                return;
            }

            // C. ÊåøÂÖ•„ÇÆ„É£„ÉÉ„Éó
            const gap = event.target.closest('.insert-gap');
            if (gap) {
                if (gap.classList.contains('active')) { resetInputState(); return; }
                resetInputState();
                insertTargetId = gap.dataset.prevId;
                gap.classList.add('active');
                textInput.classList.add('insert-mode');
                textInput.placeholder = "„Åì„Åì„Å´ÊåøÂÖ•„Åô„ÇãÊñáÁ´†„ÇíÂÖ•Âäõ...";
                textInput.focus();
                return;
            }
        }

        // --- ‰ΩúÂìÅÁÆ°ÁêÜ„Éª‰øùÂ≠ò ---
        function initializeEditor() {
            const indexData = localStorage.getItem(STORY_INDEX_KEY);
            let storyList = indexData ? JSON.parse(indexData) : [];
            if (storyList.length === 0) { createAndSwitchToNewStory(); } 
            else {
                const lastId = localStorage.getItem('ai_novel_last_open_id');
                const targetId = storyList.find(s => s.id === lastId) ? lastId : storyList[0].id;
                switchStory(targetId);
            }
        }

        function switchStory(storyId) {
            currentStoryId = storyId;
            localStorage.setItem('ai_novel_last_open_id', storyId);
            const storyList = JSON.parse(localStorage.getItem(STORY_INDEX_KEY) || '[]');
            const story = storyList.find(s => s.id === storyId);
            if (story) currentTitleSpan.textContent = story.title;
            loadManuscript(storyId);
            storyListModal.style.display = 'none';
        }

        function createAndSwitchToNewStory() {
            const newId = `story_${Date.now()}`;
            const newStory = { id: newId, title: "Êñ∞„Åó„ÅÑÁâ©Ë™û", lastModified: Date.now() };
            const storyList = JSON.parse(localStorage.getItem(STORY_INDEX_KEY) || '[]');
            storyList.unshift(newStory);
            localStorage.setItem(STORY_INDEX_KEY, JSON.stringify(storyList));
            manuscriptArea.innerHTML = ''; addInfoBlock();
            switchStory(newId);
        }

        function openStoryListModal() {
            storyListContainer.innerHTML = '';
            const storyList = JSON.parse(localStorage.getItem(STORY_INDEX_KEY) || '[]');
            storyList.forEach(story => {
                const item = document.createElement('div');
                item.className = `story-item ${story.id === currentStoryId ? 'active' : ''}`;
                const infoDiv = document.createElement('div'); infoDiv.className = 'story-info'; infoDiv.onclick = () => switchStory(story.id);
                const titleSpan = document.createElement('span'); titleSpan.className = 'story-title'; titleSpan.textContent = story.title;
                const dateSpan = document.createElement('span'); dateSpan.className = 'story-date';
                const date = new Date(story.lastModified); dateSpan.textContent = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
                infoDiv.appendChild(titleSpan); infoDiv.appendChild(dateSpan);
                const deleteBtn = document.createElement('button'); deleteBtn.className = 'story-delete-btn'; deleteBtn.textContent = 'ÂâäÈô§';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteStory(story.id); };
                item.appendChild(infoDiv); item.appendChild(deleteBtn);
                storyListContainer.appendChild(item);
            });
            storyListModal.style.display = 'block';
        }

        function deleteStory(id) {
            if (!confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            let storyList = JSON.parse(localStorage.getItem(STORY_INDEX_KEY) || '[]');
            storyList = storyList.filter(s => s.id !== id);
            localStorage.setItem(STORY_INDEX_KEY, JSON.stringify(storyList));
            localStorage.removeItem(id);
            if (id === currentStoryId) initializeEditor();
            else openStoryListModal();
        }

        function handleChangeTitle() {
            const newTitle = prompt("„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ", currentTitleSpan.textContent);
            if (newTitle && newTitle.trim() !== "") {
                currentTitleSpan.textContent = newTitle;
                const storyList = JSON.parse(localStorage.getItem(STORY_INDEX_KEY) || '[]');
                const story = storyList.find(s => s.id === currentStoryId);
                if (story) { story.title = newTitle; localStorage.setItem(STORY_INDEX_KEY, JSON.stringify(storyList)); }
            }
        }

        function handleClearAll() {
            if (confirm('ÁèæÂú®„ÅÆ‰ΩúÂìÅ„ÅÆÊñáÁ´†„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem(currentStoryId);
                manuscriptArea.innerHTML = ''; resetInputState(); addInfoBlock(); updateCharCount();
            }
        }

        function saveManuscript() {
            if (!currentStoryId) return;
            const blocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            const blockTexts = blocks.map(block => block.textContent);
            localStorage.setItem(currentStoryId, JSON.stringify(blockTexts));
            const storyList = JSON.parse(localStorage.getItem(STORY_INDEX_KEY) || '[]');
            const story = storyList.find(s => s.id === currentStoryId);
            if (story) { story.lastModified = Date.now(); localStorage.setItem(STORY_INDEX_KEY, JSON.stringify(storyList)); }
            updateCharCount();
        }

        function loadManuscript(storyId) {
            manuscriptArea.innerHTML = '';
            const savedData = localStorage.getItem(storyId);
            if (savedData) {
                const blockTexts = JSON.parse(savedData);
                if (blockTexts.length > 0) { blockTexts.forEach(text => addManuscriptBlockDOM(text)); } 
                else { addInfoBlock(); }
            } else { addInfoBlock(); }
            updateCharCount();
        }

        function addInfoBlock() {
             const info = document.createElement('div');
             info.className = 'manuscript-block info';
             const textSpan = document.createElement('span'); textSpan.className = 'block-text'; textSpan.textContent = 'Ôºà„Åì„Åì„Å´ÊñáÁ´†„ÅåÁ©ç„Åø‰∏ä„Åå„Çä„Åæ„ÅôÔºâ';
             info.appendChild(textSpan); 
             const gap = document.createElement('div'); gap.className = 'insert-gap'; gap.dataset.prevId = 'info';
             const gapBtn = document.createElement('div'); gapBtn.className = 'insert-btn'; gapBtn.textContent = '+';
             gap.appendChild(gapBtn);
             manuscriptArea.appendChild(info); manuscriptArea.appendChild(gap);
        }

        function updateCharCount() {
            const blocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            let totalCount = 0; blocks.forEach(block => { totalCount += block.textContent.length; });
            charCountDisplay.textContent = `${totalCount}ÊñáÂ≠ó`;
        }
        function handleCopyAll() {
            const blocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            if (blocks.length === 0) { alert('ÊñáÁ´†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
            const allText = blocks.map(block => block.textContent).join('\n');
            if (navigator.clipboard) { navigator.clipboard.writeText(allText).then(() => alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü')).catch(() => fallbackCopy(allText)); } 
            else { fallbackCopy(allText); }
        }
        function fallbackCopy(text) {
            const ta = document.createElement("textarea"); ta.value = text;
            ta.style.position = "fixed"; ta.style.left = "-9999px"; document.body.appendChild(ta);
            ta.focus(); ta.select(); try { document.execCommand('copy'); alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'); } catch(e){} document.body.removeChild(ta);
        }

        // --- AIÊ©üËÉΩ ---
        async function callRealAiApi(originalText, instruction = null) {
            const allBlocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info)'));
            let contextString = "";
            if (editingBlockId) {
                const idx = allBlocks.findIndex(b => b.dataset.id === editingBlockId);
                const prev = allBlocks.slice(0, idx).map(b => b.querySelector('.block-text').textContent).join('\n');
                const next = allBlocks.slice(idx + 1).map(b => b.querySelector('.block-text').textContent).join('\n');
                contextString = `„ÄêÁõ¥Ââç„ÅÆÊñáËÑà„Äë\n${prev}\n\n„ÄêÁõ¥Âæå„ÅÆÊñáËÑà„Äë\n${next}`;
            } else if (insertTargetId) {
                const idx = allBlocks.findIndex(b => b.dataset.id === insertTargetId);
                const prev = allBlocks.slice(0, idx + 1).map(b => b.querySelector('.block-text').textContent).join('\n');
                const next = allBlocks.slice(idx + 1).map(b => b.querySelector('.block-text').textContent).join('\n');
                contextString = `„ÄêÁõ¥Ââç„ÅÆÊñáËÑà„Äë\n${prev}\n\n„ÄêÁõ¥Âæå„ÅÆÊñáËÑà„Äë\n${next}`;
            } else {
                const all = allBlocks.map(b => b.querySelector('.block-text').textContent).join('\n');
                contextString = `„Äê„Åì„Çå„Åæ„Åß„ÅÆÊñáËÑà„Äë\n${all}`;
            }

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-t',},
                    body: JSON.stringify({ originalText: originalText, context: contextString, moreRequest: instruction })
                });
                if (!response.ok) throw new Error(response.statusText);
                const result = await response.json();
                if (result.success) {
                    const suggs = result.suggestionText.split(/ÊèêÊ°à\d:/).map(s => s.trim()).filter(s => s.length > 0);
                    currentSuggestions = suggs.length > 0 ? suggs : [result.suggestionText];
                    while (currentSuggestions.length < 3) currentSuggestions.push("ÔºàÊèêÊ°à„Å™„ÅóÔºâ");
                } else throw new Error(result.error);
            } catch (e) {
                console.error(e); currentSuggestions = ["„Ç®„É©„Éº: " + e.message];
            }
            switchSuggestion(0);
        }

        async function openAiModal() {
            const text = textInput.value;
            if (text.trim() === '') { alert('ÊñáÁ´†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            originalTextContent.textContent = text;
            currentSuggestions = ["ËÄÉ„Åà‰∏≠...", "ËÄÉ„Åà‰∏≠...", "ËÄÉ„Åà‰∏≠..."];
            switchSuggestion(0);
            aiModal.style.display = 'block';
            await callRealAiApi(text, null); 
        }

        async function handleAiMoreRequest(req) {
            currentSuggestions = ["ËÄÉ„ÅàÁõ¥„Åó„Å¶„ÅÑ„Åæ„Åô...", "ËÄÉ„ÅàÁõ¥„Åó„Å¶„ÅÑ„Åæ„Åô...", "ËÄÉ„ÅàÁõ¥„Åó„Å¶„ÅÑ„Åæ„Åô..."];
            switchSuggestion(0);
            await callRealAiApi(originalTextContent.textContent, req);
        }
        
        function switchSuggestion(index) {
            currentSuggestionIndex = index;
            suggestionText.textContent = currentSuggestions[index];
            tabs.forEach((tab, i) => tab.classList.toggle('active', i === index));
        }
        function handleAiDecision() {
            textInput.value = currentSuggestions[currentSuggestionIndex];
            autoResizeTextarea(); aiModal.style.display = 'none';
        }
        function autoResizeTextarea() {
            textInput.style.height = 'auto'; textInput.style.height = textInput.scrollHeight + 'px'; 
        }

    </script>
</body>
</html>
