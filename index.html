<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>AIåŸ·ç­†ã‚¨ãƒ‡ã‚£ã‚¿</title>
    <style>
        /* --- å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS PMincho", "serif";
            background-color: #f0f2f5;
            overflow: hidden; 
        }

        /* â˜…â˜…â˜… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã€Œã‚¬ãƒ¯ã€ (Absoluteãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) â˜…â˜…â˜… */
        #app-container {
            height: 100dvh; /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã«è¿½å¾“ã™ã‚‹é«˜ã• */
            width: 100%; max-width: 600px; margin: 0 auto;
            background-color: #ffffff; box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative; /* å­è¦ç´ ã®åŸºæº– */
            overflow: hidden; 
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ (absolute) --- */
        header {
            background-color: #f9f9f9; color: #333; padding: 10px 15px;
            font-size: 18px; font-weight: bold; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ddd;
            position: absolute; top: 0; left: 0; right: 0;
            z-index: 10; box-sizing: border-box; height: 57px; 
        }
        .header-title {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-size: 16px; font-weight: normal;
        }
        #copy-all-btn {
            background: none; border: none; font-size: 24px;
            color: #555; cursor: pointer; padding: 5px;
        }

        /* --- 1. åŸç¨¿è¡¨ç¤ºã‚¨ãƒªã‚¢ (absolute) --- */
        #manuscript-area {
            padding: 20px; background-color: #ffffff;
            font-size: 16px; line-height: 1.8;
            position: absolute; top: 57px; 
            /* â˜… bottom ã¯JSãŒåˆ¶å¾¡ã™ã‚‹ */
            bottom: 66px; /* åˆæœŸå€¤ */
            left: 0; right: 0; overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }
        
        /* --- ãƒ–ãƒ­ãƒƒã‚¯ & ç·¨é›†ãƒœã‚¿ãƒ³ CSS --- */
        .manuscript-block {
            padding: 10px 0; border-bottom: 1px dashed #ccc;
            display: flex; justify-content: space-between;
            align-items: flex-start; gap: 10px;
        }
        .block-text {
            flex-grow: 1; word-wrap: break-word; white-space: pre-wrap;
        }
        .edit-button {
            flex-shrink: 0; padding: 5px; cursor: pointer;
            border-radius: 4px; min-width: 20px; 
            text-align: center; font-size: 14px; color: #666;
        }
        .edit-button::before { content: '\270E'; }
        .edit-button:hover { background-color: #f0f0f0; }
        .manuscript-block.info { color: #888; }
        .manuscript-block.is-editing { background-color: #f0f8ff; }


        /* --- 2. åŸ·ç­†ã‚¨ãƒªã‚¢ (absolute) --- */
        #writing-area {
            display: flex; align-items: flex-end; padding: 10px;
            border-top: 1px solid #ddd; background-color: #f9f9f9;
            position: absolute; bottom: 0; left: 0; right: 0;
            z-index: 10; box-sizing: border-box;
        }
        #text-input {
            flex-grow: 1; font-size: 16px; padding: 10px 12px;
            border: 1px solid #ccc; border-radius: 20px;
            margin-right: 8px; resize: none; max-height: 120px; 
            overflow-y: auto;
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS PMincho", "serif";
        }
        .action-button {
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; border-radius: 50%;
            border: 1px solid #ccc; background-color: #ffffff;
            color: #555; cursor: pointer; font-size: 22px; flex-shrink: 0;
        }
        #ai-btn { margin-right: 5px; font-size: 24px; }
        #confirm-btn { font-weight: bold; }

        /* --- 3. AIææ¡ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— (å®Œå…¨ç‰ˆ) --- */
        #ai-modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content {
            position: absolute; bottom: 0; width: 100%; height: 90vh; max-width: 600px;
            left: 50%; transform: translateX(-50%); background-color: #ffffff;
            border-radius: 20px 20px 0 0; display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 15px; border-bottom: 1px solid #eee; font-size: 18px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        #close-modal { font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; padding: 5px; }
        #original-text-display {
            padding: 15px 20px; background-color: #f4f4f4; border-bottom: 1px solid #ddd;
            font-size: 15px; line-height: 1.6; color: #555; white-space: pre-wrap;
            max-height: 150px; overflow-y: auto;
        }
        .suggestion-tabs { display: flex; justify-content: space-around; border-bottom: 1px solid #eee; }
        .tab {
            padding: 15px; cursor: pointer; color: #888; font-weight: bold; border-bottom: 3px solid transparent;
        }
        .tab.active { color: #4A90E2; border-bottom-color: #4A90E2; }
        #suggestion-text {
            flex-grow: 1; padding: 20px; font-size: 16px; line-height: 1.6;
            overflow-y: auto; white-space: pre-wrap; background-color: #f9f9f9;
        }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; background-color: #f9f9f9; }
        #more-request-input {
            width: calc(100% - 24px); padding: 10px 12px; border: 1px solid #ccc;
            border-radius: 20px; margin-bottom: 10px;
        }
        #decision-btn {
            width: 100%; padding: 15px; background-color: #4CAF50; color: white; border: none;
            border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <span></span>
            <span class="header-title">AIåŸ·ç­†ã‚¨ãƒ‡ã‚£ã‚¿</span>
            <button id="copy-all-btn">ğŸ“‹</button>
        </header>
        
        <div id="manuscript-area">
            </div>
        <div id="writing-area">
            <textarea id="text-input" rows="1" placeholder="æ–‡ç« ã‚’å…¥åŠ›..."></textarea>
            <button id="ai-btn" class="action-button">âœ¨</button>
            <button id="confirm-btn" class="action-button">â¬†ï¸</button>
        </div>
    </div>

    <div id="ai-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>AIãƒªãƒ©ã‚¤ãƒˆææ¡ˆ</span>
                <span id="close-modal">Ã—</span>
            </div>
            <div id="original-text-display">ï¼ˆã“ã“ã«å…ƒã®æ–‡ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>
            <div class="suggestion-tabs">
                <span class="tab active" data-index="0">ææ¡ˆ 1</span>
                <span class="tab" data-index="1">ææ¡ˆ 2</span>
                <span class="tab" data-index="2">ææ¡ˆ 3</span>
            </div>
            <div id="suggestion-text">ï¼ˆã“ã“ã«AIã®ææ¡ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>
            <div class="modal-footer">
                <input type="text" id="more-request-input" placeholder="è¿½åŠ ã®æŒ‡ç¤ºï¼ˆä¾‹ï¼šã‚‚ã£ã¨æƒ…æ™¯æå†™ã‚’ï¼‰">
                <button id="decision-btn">ã“ã®å†…å®¹ã§æ±ºå®š</button>
            </div>
        </div>
    </div>


    <script>
        // DOMè¦ç´ ã®å–å¾—
        const textInput = document.getElementById('text-input');
        const confirmBtn = document.getElementById('confirm-btn');
        const aiBtn = document.getElementById('ai-btn');
        const manuscriptArea = document.getElementById('manuscript-area');
        const copyAllBtn = document.getElementById('copy-all-btn');
        const writingArea = document.getElementById('writing-area'); // â˜… JSåˆ¶å¾¡ã«å¿…é ˆ
        
        const aiModal = document.getElementById('ai-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const originalTextDisplay = document.getElementById('original-text-display');
        const suggestionText = document.getElementById('suggestion-text');
        const decisionBtn = document.getElementById('decision-btn');
        const moreRequestInput = document.getElementById('more-request-input');
        const tabs = document.querySelectorAll('.tab');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentSuggestions = []; 
        let currentSuggestionIndex = 0; 
        let editingBlockId = null; 
        const STORAGE_KEY = 'ai_novel_editor_data'; 
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxMCdYvJVs36E5I32cUSuqQox-1IP1L3MBQalQF_YXUF4hd1j0Bwlawvzxb_Qb38pc/exec"; // â˜…ã”è‡ªèº«ã®URLã«

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            loadManuscript();
            autoResizeTextarea(); // â˜… èµ·å‹•æ™‚ã«é«˜ã•ã‚’è¨ˆç®—
            textInput.addEventListener('input', autoResizeTextarea);
            confirmBtn.addEventListener('click', handleConfirm);
            aiBtn.addEventListener('click', openAiModal);
            copyAllBtn.addEventListener('click', handleCopyAll);
            closeModalBtn.addEventListener('click', closeAiModal);
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchSuggestion(parseInt(tab.dataset.index)));
            });
            decisionBtn.addEventListener('click', handleAiDecision);
            moreRequestInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim() !== '') {
                    handleAiMoreRequest(e.target.value); 
                    e.target.value = '';
                }
            });
            manuscriptArea.addEventListener('click', handleBlockClick); 
        });

        // --- â˜…â˜…â˜… é«˜ã•è‡ªå‹•èª¿æ•´ (JSåˆ¶å¾¡ã‚’å¾©æ´») â˜…â˜…â˜… ---
        function autoResizeTextarea() {
            // 1. ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ¬„ã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´
            textInput.style.height = 'auto'; 
            textInput.style.height = textInput.scrollHeight + 'px'; 
            
            // 2. â˜… JSåˆ¶å¾¡ã‚’å¾©æ´» â˜…
            // å…¥åŠ›æ¬„ã‚¨ãƒªã‚¢ã€Œå…¨ä½“ã€ã®é«˜ã•ã‚’å–å¾—
            const writingAreaHeight = writingArea.offsetHeight;
            
            // 3. åŸç¨¿ã‚¨ãƒªã‚¢ã®ã€Œä¸‹ç«¯(bottom)ã€ã‚’ã€å…¥åŠ›æ¬„ã®é«˜ã•åˆ†ã ã‘å‹•çš„ã«å¤‰æ›´
            manuscriptArea.style.bottom = writingAreaHeight + 'px';
        }
        
        // --- ç¢ºå®šãƒ»ç·¨é›†ãƒ»ã‚³ãƒ”ãƒ¼ãƒ»ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ (ç·¨é›†ãƒœã‚¿ãƒ³å¯¾å¿œç‰ˆ) ---
        function handleConfirm() {
            const text = textInput.value;
            if (text.trim() === '') {
                if (editingBlockId) {
                    const editingBlock = document.querySelector(`[data-id="${editingBlockId}"]`);
                    if (editingBlock) editingBlock.classList.remove('is-editing');
                    editingBlockId = null;
                }
                textInput.value = ''; autoResizeTextarea(); return;
            }
            if (editingBlockId) {
                const editingBlock = document.querySelector(`[data-id="${editingBlockId}"]`);
                if (editingBlock) {
                    const textSpan = editingBlock.querySelector('.block-text');
                    if (textSpan) textSpan.textContent = text;
                    editingBlock.classList.remove('is-editing');
                }
                editingBlockId = null;
            } else {
                addManuscript(text);
            }
            textInput.value = ''; autoResizeTextarea();
            saveManuscript();
        }

        function handleBlockClick(event) {
            const clickedButton = event.target.closest('.edit-button');
            if (!clickedButton) return;
            const clickedBlock = clickedButton.closest('.manuscript-block');
            if (!clickedBlock || clickedBlock.classList.contains('info') || clickedBlock.classList.contains('is-editing')) {
                return;
            }
            if (editingBlockId) {
                const prevEditingBlock = document.querySelector(`[data-id="${editingBlockId}"]`);
                if (prevEditingBlock) prevEditingBlock.classList.remove('is-editing');
            }
            editingBlockId = clickedBlock.dataset.id;
            clickedBlock.classList.add('is-editing');
            textInput.value = clickedBlock.querySelector('.block-text').textContent;
            autoResizeTextarea();
            textInput.focus();
            saveManuscript();
        }

        function handleCopyAll() {
            const blocks = manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text');
            const allText = Array.from(blocks).map(block => block.textContent).join('\n\n');
            if (allText.trim() === '') {
                alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–‡ç« ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return;
            }
            navigator.clipboard.writeText(allText)
                .then(() => { alert('åŸç¨¿å…¨ä½“ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'); })
                .catch(err => { console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err); alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); });
        }

        function addManuscript(text, isLoading = false) {
            const block = document.createElement('div');
            block.className = 'manuscript-block';
            block.dataset.id = `block-${Date.now()}-${Math.random()}`;
            const textSpan = document.createElement('span');
            textSpan.className = 'block-text';
            textSpan.textContent = text;
            const editBtn = document.createElement('span');
            editBtn.className = 'edit-button';
            block.appendChild(textSpan);
            block.appendChild(editBtn);
            manuscriptArea.appendChild(block);
            if (!isLoading) {
                 manuscriptArea.scrollTop = manuscriptArea.scrollHeight;
            }
        }
        function saveManuscript() {
            const blocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            const blockTexts = blocks.map(block => block.textContent);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(blockTexts));
        }
        function loadManuscript() {
            manuscriptArea.innerHTML = ''; 
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const blockTexts = JSON.parse(savedData);
                if (blockTexts.length > 0) {
                    blockTexts.forEach(text => addManuscript(text, true));
                } else { addInfoBlock(); }
            } else { addInfoBlock(); }
        }
        function addInfoBlock() {
             const info = document.createElement('div');
             info.className = 'manuscript-block info';
             const textSpan = document.createElement('span');
             textSpan.className = 'block-text';
             textSpan.textContent = 'ï¼ˆã“ã“ã«ç¢ºå®šã—ãŸæ–‡ç« ãŒç©ã¿ä¸ŠãŒã£ã¦ã„ãã¾ã™...ï¼‰';
             info.appendChild(textSpan);
             manuscriptArea.appendChild(info);
        }

        // --- AIãƒ»UIé–¢é€£ (å®Œå…¨ç‰ˆ) ---
        async function openAiModal() { 
            const text = textInput.value;
            if (text.trim() === '') {
                alert('å…ˆã«æ”¹å–„ã—ãŸã„æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;
            }
            originalTextDisplay.textContent = text; 
            currentSuggestions = ["AIãŒè€ƒãˆä¸­ã§ã™...", "AIãŒè€ƒãˆä¸­ã§ã™...", "AIãŒè€ƒãˆä¸­ã§ã™..."];
            switchSuggestion(0);
            aiModal.style.display = 'block';
            await callRealAiApi(text, null); 
        }
        function closeAiModal() { aiModal.style.display = 'none'; }
        function switchSuggestion(index) {
            currentSuggestionIndex = index;
            suggestionText.textContent = currentSuggestions[index]; 
            tabs.forEach((tab, i) => tab.classList.toggle('active', i === index)); 
        }
        function handleAiDecision() {
            textInput.value = currentSuggestions[currentSuggestionIndex];
            autoResizeTextarea();
            closeAiModal();
        }
        async function handleAiMoreRequest(requestText) {
            alert(`ã€Œ${requestText}ã€ã¨ã„ã†æŒ‡ç¤ºã§ã€AIã«å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚`);
            const originalText = originalTextDisplay.textContent; 
            currentSuggestions = ["AIãŒè€ƒãˆä¸­ã§ã™...", "AIãŒè€ƒãˆä¸­ã§ã™...", "AIãŒè€ƒãˆä¸­ã§ã™..."];
            switchSuggestion(0);
            await callRealAiApi(originalText, requestText);
        }
        
        // --- AIå‘¼ã³å‡ºã— (å®Œå…¨ç‰ˆ) ---
// --- AIå‘¼ã³å‡ºã— (æ–‡è„ˆåˆ¶é™ç‰ˆ) ---
        async function callRealAiApi(originalText, moreRequest) {
            console.log("AIã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­:", originalText);
            if (moreRequest) console.log("è¿½åŠ æŒ‡ç¤º:", moreRequest);
            
            // 1. å…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å–å¾—
            const allBlocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            
            // 2. â˜…å¤‰æ›´: ç›´è¿‘ã®20ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã‚’å–ã‚Šå‡ºã™ (å¾Œã‚ã‹ã‚‰20å€‹)
            // â€»ã€Œ20ã€ã¨ã„ã†æ•°å­—ã¯ãŠå¥½ã¿ã§èª¿æ•´å¯èƒ½ã§ã™
            const recentBlocks = allBlocks.slice(-20);
            
            // 3. æ–‡è„ˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
            const context = recentBlocks.map(b => b.textContent).join('\n\n');
            
            console.log(`æ–‡è„ˆã¨ã—ã¦é€ä¿¡ã™ã‚‹ãƒ–ãƒ­ãƒƒã‚¯æ•°: ${recentBlocks.length}/${allBlocks.length}`);

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST', mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ 
                        originalText: originalText, context: context, moreRequest: moreRequest 
                    })
                });
                if (!response.ok) throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.statusText}`);
                const result = await response.json();
                if (result.success) {
                    const aiResponseText = result.suggestionText;
                    const suggestions = aiResponseText.split(/ææ¡ˆ\d:/).map(s => s.trim()).filter(s => s.length > 0);
                    if (suggestions.length > 0) {
                        currentSuggestions = suggestions;
                        while (currentSuggestions.length < 3) currentSuggestions.push("ï¼ˆææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰");
                    } else {
                        currentSuggestions = [aiResponseText, "ï¼ˆè§£æå¤±æ•—ï¼‰", "ï¼ˆè§£æå¤±æ•—ï¼‰"];
                    }
                } else {
                    throw new Error(`GASã‚¨ãƒ©ãƒ¼: ${result.error}`);
                }
            } catch (error) {
                console.error("AIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:", error);
                currentSuggestions = [
                    `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`,
                    "APIã‚­ãƒ¼ã¾ãŸã¯GASã®URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
                    "æ™‚é–“ã‚’ãŠã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚"
                ];
            }
            switchSuggestion(0);
        }
    </script>
</body>
</html>