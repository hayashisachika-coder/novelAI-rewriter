<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>AIÂü∑Á≠Ü„Ç®„Éá„Ç£„Çø</title>
    <style>
        /* --- ÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´ --- */
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS PMincho", "serif";
            background-color: #f0f2f5;
        }
        #app-container {
            display: flex; flex-direction: column; height: 100vh;
            width: 100%; max-width: 600px; margin: 0 auto;
            background-color: #ffffff; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* --- „Éò„ÉÉ„ÉÄ„Éº --- */
        header {
            background-color: #f9f9f9; color: #333; padding: 12px 15px;
            font-size: 16px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ddd;
        }
        #copy-all-btn {
            background: none; border: 1px solid #ccc; border-radius: 5px;
            cursor: pointer; padding: 5px 10px; font-size: 18px; background-color: #fff;
        }
        #copy-all-btn:active { background-color: #e0e0e0; }
        #char-count {
            font-size: 12px; font-weight: normal; color: #666;
            background-color: #eee; padding: 4px 8px; border-radius: 10px;
        }

        /* --- ÂéüÁ®ø„Ç®„É™„Ç¢ --- */
        #manuscript-area {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            background-color: #ffffff; font-size: 16px; line-height: 1.8;
        }
        .manuscript-block {
            padding: 10px 0; border-bottom: 1px dashed #ccc;
            display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;
        }
        .block-text { flex-grow: 1; word-wrap: break-word; white-space: pre-wrap; }
        .edit-button {
            flex-shrink: 0; padding: 5px; cursor: pointer; border-radius: 4px;
            min-width: 20px; text-align: center; font-family: sans-serif;
        }
        .edit-button:hover { background-color: #f0f0f0; }
        .manuscript-block.info { color: #888; cursor: default; }
        .manuscript-block.is-editing { background-color: #f0f8ff; }

        /* --- Âü∑Á≠Ü„Ç®„É™„Ç¢ --- */
        #writing-area {
            display: flex; align-items: flex-end; padding: 10px;
            border-top: 1px solid #ddd; background-color: #f9f9f9;
        }
        #text-input {
            flex-grow: 1; font-size: 16px; padding: 10px 12px; border: 1px solid #ccc;
            border-radius: 20px; margin-right: 8px; resize: none; max-height: 120px; overflow-y: auto;
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS PMincho", "serif";
        }
        .action-button {
            display: flex; align-items: center; justify-content: center; width: 44px; height: 44px;
            border-radius: 50%; border: none; cursor: pointer; font-size: 20px; flex-shrink: 0;
        }
        #ai-btn { background-color: #8E44AD; color: white; margin-right: 5px; }
        #confirm-btn { background-color: #4A90E2; color: white; }

        /* --- AI„É¢„Éº„ÉÄ„É´ --- */
        #ai-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content { position: absolute; bottom: 0; width: 100%; height: 90vh; max-width: 600px; left: 50%; transform: translateX(-50%); background-color: #ffffff; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #close-modal { font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; padding: 5px; }
        
        /* ÂÖÉ„ÅÆÊñáÁ´†Ë°®Á§∫„Ç®„É™„Ç¢ */
        #original-text-area {
            padding: 10px 15px;
            background-color: #f7f7f7; /* ËñÑ„ÅÑ„Ç∞„É¨„Éº */
            border-bottom: 1px solid #eee;
            max-height: 100px; /* Èï∑„Åô„Åé„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
            overflow-y: auto;
        }
        .original-label {
            font-size: 12px; font-weight: bold; color: #888; display: block; margin-bottom: 5px;
        }
        #original-text-content {
            font-size: 14px; color: #555; white-space: pre-wrap;
        }

        .suggestion-tabs { display: flex; justify-content: space-around; border-bottom: 1px solid #eee; }
        .tab { padding: 15px; cursor: pointer; color: #888; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { color: #4A90E2; border-bottom-color: #4A90E2; }
        #suggestion-text { flex-grow: 1; padding: 20px; font-size: 16px; line-height: 1.6; overflow-y: auto; white-space: pre-wrap; background-color: #f9f9f9; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; background-color: #f9f9f9; }
        #more-request-input { width: calc(100% - 24px); padding: 10px 12px; border: 1px solid #ccc; border-radius: 20px; margin-bottom: 10px; }
        #decision-btn { width: 100%; padding: 15px; background-color: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <button id="copy-all-btn" title="ÂÖ®Êñá„Ç≥„Éî„Éº">üìã</button>
            <span id="char-count">0ÊñáÂ≠ó</span>
        </header>

        <div id="manuscript-area"></div>

        <div id="writing-area">
            <textarea id="text-input" rows="1" placeholder="ÊñáÁ´†„ÇíÂÖ•Âäõ..."></textarea>
            <button id="ai-btn" class="action-button">‚ú®</button>
            <button id="confirm-btn" class="action-button">‚¨ÜÔ∏è</button>
        </div>
    </div>

    <div id="ai-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>AI„É™„É©„Ç§„ÉàÊèêÊ°à</span>
                <span id="close-modal">√ó</span>
            </div>
            
            <div id="original-text-area">
                <span class="original-label">ÂÖÉ„ÅÆÊñáÁ´†:</span>
                <div id="original-text-content"></div>
            </div>
            
            <div class="suggestion-tabs">
                <span class="tab active" data-index="0">ÊèêÊ°à 1</span>
                <span class="tab" data-index="1">ÊèêÊ°à 2</span>
                <span class="tab" data-index="2">ÊèêÊ°à 3</span>
            </div>
            <div id="suggestion-text">Ôºà„Åì„Åì„Å´AI„ÅÆÊèêÊ°à„ÅåË°®Á§∫„Åï„Çå„Åæ„ÅôÔºâ</div>
            <div class="modal-footer">
                <input type="text" id="more-request-input" placeholder="ËøΩÂä†„ÅÆÊåáÁ§∫Ôºà‰æãÔºö„ÇÇ„Å£„Å®ÊÉÖÊôØÊèèÂÜô„ÇíÔºâ">
                <button id="decision-btn">„Åì„ÅÆÂÜÖÂÆπ„ÅßÊ±∫ÂÆö</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOMË¶ÅÁ¥† ---
        const textInput = document.getElementById('text-input');
        const confirmBtn = document.getElementById('confirm-btn');
        const aiBtn = document.getElementById('ai-btn');
        const manuscriptArea = document.getElementById('manuscript-area');
        const charCountDisplay = document.getElementById('char-count');
        const copyAllBtn = document.getElementById('copy-all-btn');
        
        const aiModal = document.getElementById('ai-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const suggestionText = document.getElementById('suggestion-text');
        const decisionBtn = document.getElementById('decision-btn');
        const moreRequestInput = document.getElementById('more-request-input');
        const tabs = document.querySelectorAll('.tab');
        
        // ÂÖÉ„ÅÆÊñáÁ´†Ë°®Á§∫Áî®
        const originalTextContent = document.getElementById('original-text-content');

        // --- „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ---
        let currentSuggestions = []; 
        let currentSuggestionIndex = 0; 
        let editingBlockId = null; 
        const STORAGE_KEY = 'ai_novel_editor_data'; 
        
        // ‚òÖ‚òÖ‚òÖ GAS URL („Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ) ‚òÖ‚òÖ‚òÖ
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxMCdYvJVs36E5I32cUSuqQox-1IP1L3MBQalQF_YXUF4hd1j0Bwlawvzxb_Qb38pc/exec"; 
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        document.addEventListener('DOMContentLoaded', () => {
            loadManuscript();
            textInput.addEventListener('input', autoResizeTextarea);
            confirmBtn.addEventListener('click', handleConfirm);
            
            aiBtn.addEventListener('click', openAiModal);
            closeModalBtn.addEventListener('click', closeAiModal);
            tabs.forEach(tab => tab.addEventListener('click', () => switchSuggestion(parseInt(tab.dataset.index))));
            decisionBtn.addEventListener('click', handleAiDecision);
            
            moreRequestInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim() !== '') {
                    // ‚òÖ‰øÆÊ≠£: Êú¨Áâ©„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô
                    handleAiMoreRequest(e.target.value); 
                    e.target.value = '';
                }
            });
            
            manuscriptArea.addEventListener('click', handleBlockClick);
            copyAllBtn.addEventListener('click', handleCopyAll);
        });

        // --- Èñ¢Êï∞ ---

        // ÂÖ®Êñá„Ç≥„Éî„Éº
        function handleCopyAll() {
            const blocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            if (blocks.length === 0) { alert('„Ç≥„Éî„Éº„Åô„ÇãÊñáÁ´†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ'); return; }
            const allText = blocks.map(block => block.textContent).join('\n');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(allText).then(() => { alert('ÂÖ®Êñá„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'); })
                .catch(err => { fallbackCopyTextToClipboard(allText); });
            } else { fallbackCopyTextToClipboard(allText); }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try { document.execCommand('copy'); alert('ÂÖ®Êñá„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'); } 
            catch (err) { alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); }
            document.body.removeChild(textArea);
        }

        // Á¢∫ÂÆö„Éú„Çø„É≥
        function handleConfirm() {
            const text = textInput.value;
            if (text.trim() === '') {
                if (editingBlockId) {
                    const editingBlock = document.querySelector(`[data-id="${editingBlockId}"]`);
                    if (editingBlock) editingBlock.classList.remove('is-editing');
                    editingBlockId = null;
                }
                textInput.value = ''; autoResizeTextarea(); return;
            }
            if (editingBlockId) {
                const editingBlock = document.querySelector(`[data-id="${editingBlockId}"]`);
                if (editingBlock) {
                    const textSpan = editingBlock.querySelector('.block-text');
                    if (textSpan) textSpan.textContent = text;
                    editingBlock.classList.remove('is-editing');
                }
                editingBlockId = null;
            } else { addManuscript(text); }
            textInput.value = ''; autoResizeTextarea();
            saveManuscript();
        }

        // „Éñ„É≠„ÉÉ„ÇØËøΩÂä†
        function addManuscript(text, isLoading = false) {
            const block = document.createElement('div');
            block.className = 'manuscript-block';
            block.dataset.id = `block-${Date.now()}-${Math.random()}`;
            const textSpan = document.createElement('span');
            textSpan.className = 'block-text';
            textSpan.textContent = text;
            const editBtn = document.createElement('span');
            editBtn.className = 'edit-button';
            editBtn.textContent = '‚úèÔ∏è';
            block.appendChild(textSpan); block.appendChild(editBtn);
            manuscriptArea.appendChild(block);
            if (!isLoading) manuscriptArea.scrollTop = manuscriptArea.scrollHeight;
        }
        
        // „Éñ„É≠„ÉÉ„ÇØÁ∑®ÈõÜÈñãÂßã
        function handleBlockClick(event) {
            const clickedButton = event.target.closest('.edit-button');
            if (!clickedButton) return;
            const clickedBlock = clickedButton.closest('.manuscript-block');
            if (!clickedBlock || clickedBlock.classList.contains('info') || clickedBlock.classList.contains('is-editing')) return;
            if (editingBlockId) {
                const prevEditingBlock = document.querySelector(`[data-id="${editingBlockId}"]`);
                if (prevEditingBlock) prevEditingBlock.classList.remove('is-editing');
            }
            editingBlockId = clickedBlock.dataset.id;
            clickedBlock.classList.add('is-editing');
            textInput.value = clickedBlock.querySelector('.block-text').textContent;
            autoResizeTextarea(); textInput.focus();
            saveManuscript();
        }

        // ‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø„ÉªÊñáÂ≠óÊï∞
        function saveManuscript() {
            const blocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            const blockTexts = blocks.map(block => block.textContent);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(blockTexts));
            updateCharCount();
        }
        function loadManuscript() {
            manuscriptArea.innerHTML = ''; 
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const blockTexts = JSON.parse(savedData);
                if (blockTexts.length > 0) { blockTexts.forEach(text => addManuscript(text, true)); } 
                else { addInfoBlock(); }
            } else { addInfoBlock(); }
            updateCharCount();
        }
        function updateCharCount() {
            const blocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            let totalCount = 0;
            blocks.forEach(block => { totalCount += block.textContent.length; });
            charCountDisplay.textContent = `${totalCount}ÊñáÂ≠ó`;
        }
        function addInfoBlock() {
             const info = document.createElement('div');
             info.className = 'manuscript-block info';
             const textSpan = document.createElement('span');
             textSpan.className = 'block-text';
             textSpan.textContent = 'Ôºà„Åì„Åì„Å´Á¢∫ÂÆö„Åó„ÅüÊñáÁ´†„ÅåÁ©ç„Åø‰∏ä„Åå„Å£„Å¶„ÅÑ„Åç„Åæ„Åô...Ôºâ';
             info.appendChild(textSpan); manuscriptArea.appendChild(info);
        }

        // --- ‚òÖ‚òÖ‚òÖ AIÂëº„Å≥Âá∫„ÅóÔºà‰øÆÊ≠£ÁâàÔºöÊåáÁ§∫ÂØæÂøúÔºâ ‚òÖ‚òÖ‚òÖ ---
        async function callRealAiApi(originalText, instruction = null) {
            console.log("AI„Çµ„Éº„Éê„Éº„Å´„É™„ÇØ„Ç®„Çπ„Éà‰∏≠:", originalText, "ÊåáÁ§∫:", instruction);
            
            const contextBlocks = Array.from(manuscriptArea.querySelectorAll('.manuscript-block:not(.info) .block-text'));
            const context = contextBlocks.map(b => b.textContent).join('\n\n');
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-t',},
                    // ‚òÖ‚òÖ‚òÖ ‰øÆÊ≠£ÁÇπ: moreRequest „Å®„ÅÑ„ÅÜÂ§âÊï∞Âêç„ÅßÈÄÅ„Çã ‚òÖ‚òÖ‚òÖ
                    body: JSON.stringify({ 
                        originalText: originalText, 
                        context: context,
                        moreRequest: instruction // ‚Üê GASÂÅ¥„Å®Âêà„Çè„Åõ„Çã
                    })
                });

                if (!response.ok) { throw new Error(`„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ${response.statusText}`); }
                const result = await response.json();
                
                if (result.success) {
                    const aiResponseText = result.suggestionText;
                    const suggestions = aiResponseText.split(/ÊèêÊ°à\d:/).map(s => s.trim()).filter(s => s.length > 0);
                    if (suggestions.length > 0) {
                        currentSuggestions = suggestions;
                        while (currentSuggestions.length < 3) { currentSuggestions.push("ÔºàÊèêÊ°à„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºâ"); }
                    } else { currentSuggestions = [aiResponseText, "ÔºàËß£ÊûêÂ§±ÊïóÔºâ", "ÔºàËß£ÊûêÂ§±ÊïóÔºâ"]; }
                } else { throw new Error(`GAS„Ç®„É©„Éº: ${result.error}`); }

            } catch (error) {
                console.error("AIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº:", error);
                currentSuggestions = [`„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`, "Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"];
            }
            switchSuggestion(0);
        }

        // AI UIÂà∂Âæ°
        async function openAiModal() {
            const text = textInput.value;
            if (text.trim() === '') { alert('ÊñáÁ´†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
            
            // ÂÖÉ„ÅÆÊñáÁ´†„Çí„Çª„ÉÉ„Éà
            originalTextContent.textContent = text;
            
            currentSuggestions = ["AI„ÅåËÄÉ„Åà‰∏≠„Åß„Åô...", "AI„ÅåËÄÉ„Åà‰∏≠„Åß„Åô...", "AI„ÅåËÄÉ„Åà‰∏≠„Åß„Åô..."];
            switchSuggestion(0);
            aiModal.style.display = 'block';
            
            // ÂàùÂõû„É™„ÇØ„Ç®„Çπ„ÉàÔºàÊåáÁ§∫„Å™„ÅóÔºâ
            await callRealAiApi(text, null); 
        }

        // --- ‚òÖ‚òÖ‚òÖ ËøΩÂä†ÊåáÁ§∫„ÅÆÂá¶ÁêÜÔºàÊú¨Áâ©Ôºâ ‚òÖ‚òÖ‚òÖ ---
        async function handleAiMoreRequest(requestText) {
            // UI„Çí„ÄåËÄÉ„Åà‰∏≠„Äç„Å´Êàª„Åô
            currentSuggestions = [`„Äå${requestText}„Äç„ÇíË∏è„Åæ„Åà„Å¶ËÄÉ„ÅàÁõ¥„Åó„Å¶„ÅÑ„Åæ„Åô...`, "ËÄÉ„Åà‰∏≠...", "ËÄÉ„Åà‰∏≠..."];
            switchSuggestion(0);
            
            // ÂÖÉ„ÅÆÊñáÁ´†„ÇíÂèñÂæó
            const originalText = originalTextContent.textContent;
            
            // ÊåáÁ§∫‰ªò„Åç„ÅßÂÜç„É™„ÇØ„Ç®„Çπ„Éà
            await callRealAiApi(originalText, requestText);
        }
        
        function closeAiModal() { aiModal.style.display = 'none'; }
        function switchSuggestion(index) {
            currentSuggestionIndex = index;
            suggestionText.textContent = currentSuggestions[index];
            tabs.forEach((tab, i) => tab.classList.toggle('active', i === index));
        }
        function handleAiDecision() {
            textInput.value = currentSuggestions[currentSuggestionIndex];
            autoResizeTextarea(); closeAiModal();
        }
        function autoResizeTextarea() {
            textInput.style.height = 'auto'; textInput.style.height = textInput.scrollHeight + 'px'; 
        }

    </script>
</body>
</html>
